<template>
    <div class="hello">
        <div class="text-center">
            <h4 class="m-0" v-if="team">{{ team.name }}</h4>
            <span class="font-weight-light">team</span>
        </div>

        <div class="text-center">
            <h4 class="m-0" v-if="teamDivision"> {{ teamDivision.name }}</h4>
            <span class="font-weight-light">division</span>
        </div>

        <div class="text-center" v-if="team">
            <div v-if="team.players.length > 0" class="mt-4">
            <h5 v-for="player in team.players">
                {{player.firstName}} {{player.lastName}}
            </h5>
            </div>
            <p v-else class="text-secondary my-4 h5">There are no players in this team</p>
        </div>

        <div class="actions mt-5" v-if="teamActions">
            <div class="addAndRemove d-flex justify-content-around">
                <button class="btn btn-outline-success btnWidth40" 
                    @click.prevent="getAllPlayers(); openAddPlayerAction(); hideTeamActions()">
                    Ad player
                </button>
                <button class="btn btn-outline-danger btnWidth40"
                    @click.prevent="openRemovePlayerAction(); hideTeamActions()">
                    Remove player
                </button>
            </div>
            <div class="d-flex justify-content-center mt-4">
                <button class="btn btn-outline-primary btnWidth60"
                    @click.prevent="setDivisionsToTransferTo(); showTransferTeamAction(); hideTeamActions()">
                    Transfer team
                </button>
            </div>
            <div class="d-flex justify-content-center mt-4">
                <button class="btn btn-outline-danger btnWidth60" @click.prevent="deleteTeam()">DELETE team</button>
            </div>
        </div>
        
        <div class="d-flex justify-content-center mt-4">

            <div class="card" style="width: 20rem;" v-if="displayAddPlayerBox">
                <div class="card-body">
                    <div class="d-flex flex-row justify-content-between align-items-center">
                        <h5 class="card-title m-0">Add Player</h5>
                        <i class="fas fa-times" @click.prevent="hideAddPlayerAction(); showTeamActions()"></i>
                    </div>
                    <hr>

                    <div v-if="allPlayers">
                        <h6 class="card-subtitle mb-2 text-muted">Select one:</h6>
                        <select class="custom-select" id="playerToAdd" v-model="playerToAdd">
                            <option v-for="player in allPlayers" :value="player._id">
                                {{ player.firstName }} {{ player.lastName }}
                            </option>
                        </select>
                    </div>

                    <button class="btn btn-outline-success btn-small mt-3" @click.prevent="addPlayer()">Add</button>
                    <div v-if="message" class="mt-3">
                        <p class="text-danger h6">{{ message }}</p>
                    </div>
                </div>
            </div>

            <div class="card" style="width: 20rem;" v-if="displayRemovePlayerBox">
                <div class="card-body">
                    <div class="d-flex flex-row justify-content-between align-items-center">
                        <h5 class="card-title m-0">Remove Player</h5>
                        <i class="fas fa-times" @click.prevent="hideRemovePlayerAction(); showTeamActions()"></i>
                    </div>
                    <hr>

                    <div v-if="team">
                        <h6 class="card-subtitle mb-2 text-muted">Select one:</h6>
                        <select class="custom-select" v-model="playerToRemove">
                            <option v-for="player in team.players" :value="player._id">
                                {{ player.firstName }} {{ player.lastName }}
                            </option>
                        </select>
                    </div>

                    <button class="btn btn-outline-danger btn-small mt-3" @click.prevent="removePlayer()">Remove</button>
                    <div v-if="message" class="mt-3">
                        <p class="text-danger h6">{{ message }}</p>
                    </div>
                </div>
            </div>

            <div class="card" style="width: 20rem;" v-if="displayTransferTeamBox">
                <div class="card-body">
                    <div class="d-flex flex-row justify-content-between align-items-center">
                        <h5 class="card-title m-0">Transfer team</h5>
                        <i class="fas fa-times" @click.prevent="hideTransferTeamAction(); showTeamActions()"></i>
                    </div>
                    <hr>

                    <div v-if="divisionsToTransferTo">
                        <h6 class="card-subtitle mb-2 text-muted">Select one:</h6>
                        <select class="custom-select" v-model="divisionToTransferTo">
                            <option v-for="division in divisionsToTransferTo" :value="division._id">
                                {{ division.name }}
                            </option>
                        </select>
                    </div>

                    <button class="btn btn-outline-success btn-small mt-3" @click.prevent="transferTeam()">Transfer</button>
                    <div v-if="message" class="mt-3">
                        <p class="text-danger h6">{{ message }}</p>
                    </div>
                </div>
            </div>

        </div>

    </div>
</template>

<script>
import { mapGetters, mapState } from "vuex"
import services from "../../services/event-service"
  
export default {
    props: [ 'dayId', 'divisionId', 'teamId'],
    data() {
        return {
            divisionsToTransferTo: null,
            divisionToTransferTo: null,

            teamDivision: null,
            team: null,

            playerToAdd: null,
            playerToRemove: null,

            message: null,

            displayAddPlayerBox: false,
            displayRemovePlayerBox: false,
            displayTransferTeamBox: false,
            teamActions: true
        }
    },
    methods: {
        setDivisionsToTransferTo(){
            let leagueDay = this.getDayById(this.dayId)
            this.divisionsToTransferTo = leagueDay.divisions.filter(division => division._id !== this.divisionId)
        },
        setTeamDivision(){
            this.teamDivision = this.getDivisionById(this.divisionId)
        },
        fetchTeam(){
            services.getTeam({ dayId:this.dayId, divisionId: this.divisionId, teamId: this.teamId })
                .then(res => {
                    this.team = res.data.team
                })
                .catch(err => console.log(err))
        },
        deleteTeam(){
            services.deleteTeam({ dayId:this.dayId, divisionId: this.divisionId, teamId: this.teamId })
                .then(res => {
                    this.$router.push({ name: 'AdminHome' })
                    this.$store.dispatch('notification/add', res.data.notification, {root:true})
                })
                .catch(err => console.log(err))
        },
        getAllPlayers(){
            this.$store.dispatch('getAllPlayers')
        },
        openAddPlayerAction(){
            this.displayAddPlayerBox = true
        },
        hideAddPlayerAction(){
            this.displayAddPlayerBox = false
        },
        addPlayer(){
            if(this.playerToAdd) {
                console.log(this.playerToAdd)
                services.addPlayer({ dayId: this.dayId, divisionId: this.divisionId, teamId: this.teamId, playerId: this.playerToAdd })
                    .then(res => {
                        this.team = res.data.updatedTeam,
                        this.$store.dispatch("notification/add", res.data.notification , { root: true })
                        this.hideAddPlayerAction()
                        this.showTeamActions()
                    })
                    .catch(err => {
                        if(err.response.status == 409) {
                            this.$store.dispatch("notification/add", err.response.data.notification , { root: true })
                        }
                    })
            } else {
                this.showAndHideErrorMessage()
            }
        },
        openRemovePlayerAction(){
            this.displayRemovePlayerBox = true
        },
        hideRemovePlayerAction(){
            this.displayRemovePlayerBox = false
        },
        removePlayer(){
            if(this.playerToRemove){
                services.removePlayer({ dayId: this.dayId, divisionId: this.divisionId, teamId: this.teamId, playerId: this.playerToRemove })
                    .then(res => {
                        this.team = res.data.updatedTeam,
                        this.$store.dispatch("notification/add", res.data.notification , { root: true })
                        this.hideRemovePlayerAction()
                        this.showTeamActions()                        
                    })
                    .catch(err => console.log(err))
            } else {
                this.showAndHideErrorMessage()
            }
        },
        showAndHideErrorMessage(){
            this.message = 'Please make a selection'
            setTimeout( () => {
                this.message = null
            }, 4000)
        },
        hideTeamActions(){
            this.teamActions = false
        },
        showTeamActions(){
            this.teamActions = true
        },
        hideTransferTeamAction(){
            this.displayTransferTeamBox = false
        },
        showTransferTeamAction(){
            this.displayTransferTeamBox = true
        },
        transferTeam(){
            services.transferTeamBetweenDivisions({dayId: this.dayId, teamId: this.teamId, currentDivisionId: this.divisionId, divisionToTransferToId: this.divisionToTransferTo})
            .then(res => {
                this.$store.dispatch('notification/add', res.data.notification)
                this.$router.push({ name:'AdminHome' })
            })
            .catch(err => {
                console.log(err)
            })
        }
  },
  created() {
        this.setTeamDivision(),
        this.fetchTeam()
  },
    computed: {
        ...mapGetters(['getDivisionById', 'getDayById']),
        ...mapState(['allPlayers'])
  }
};
</script>

<style scoped>
.hello {
  margin: 10vh 0;
}
.section {
  border-top: 1px solid black;
  border-bottom: 1px solid black;
  padding: 20px 0;
}
.btnWidth40{
    width:40%;
}
.btnWidth60{
    width: 60%;
}
</style>